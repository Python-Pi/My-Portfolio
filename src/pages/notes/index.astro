---
import BaseLayout from '../../layouts/BaseLayout.astro';
import SEO from '../../components/SEO.astro';
import PageStats from '../../components/PageStats.astro';
import { pagesConfig } from '../../pages.config';
import { notesIndex } from '../../content/notes/notes-index';
import type { NotesEntryCollection, NotesEntry, NotesFolder } from '../../content/notes/notes-index';
import { getEntry } from 'astro:content';

const config = pagesConfig.notes;
const MAX_ENTRIES_PER_FOLDER = 2;

type NotesEntryWithContent = NotesEntry & {
  resolvedTitle: string;
  resolvedDescription?: string;
  publishDate?: Date;
};
type NotesFolderWithContent = NotesFolder & { entries: NotesEntryWithContent[] };

const foldersWithDescriptions = (await Promise.all(
  notesIndex.map(async (folder) => ({
    ...folder,
    entries: (
      await Promise.all(
        folder.entries.map(async (entry) => {
          const contentEntry = await getEntry(entry.collection, entry.slug);
          const slugSegment = entry.slug.split('/').pop() ?? entry.slug;
          const fallbackTitle = slugSegment
            .replace(/-/g, ' ')
            .replace(/\b\w/g, (char) => char.toUpperCase());
          const resolvedTitle = contentEntry?.data.title ?? fallbackTitle;
          const publishDate = contentEntry?.data.publishDate as Date | undefined;
          return {
            ...entry,
            resolvedTitle,
            resolvedDescription: contentEntry?.data.description ?? entry.summary ?? '',
            publishDate,
          } satisfies NotesEntryWithContent;
        })
      )
    ).sort((a, b) => {
      const dateA = a.publishDate ? a.publishDate.getTime() : 0;
      const dateB = b.publishDate ? b.publishDate.getTime() : 0;
      return dateB - dateA;
    }),
  }))
)) as NotesFolderWithContent[];

const typedFolders = foldersWithDescriptions as NotesFolderWithContent[];

const leftColumnFolders = typedFolders.filter((_, i) => i % 2 === 0);
const rightColumnFolders = typedFolders.filter((_, i) => i % 2 === 1);

const totalEntries = foldersWithDescriptions.reduce((count, folder) => count + folder.entries.length, 0);

const collectionLabel = (_collection: NotesEntryCollection) => 'Blog';
const entryHref = (_collection: NotesEntryCollection, slug: string) => `/blogs/${slug}`;
---

<BaseLayout>
  <SEO 
    slot="head"
    title={config.title}
    description={config.description}
    type="website"
  />

  <main class="notes-page">
    <header class="page-header">
      <p class="page-label">Notes</p>
      <h1 class="page-title">{config.heading}</h1>
      {config.intro && <p class="page-intro">{config.intro}</p>}
      <div class="page-meta">
        <PageStats text={`${typedFolders.length} folder${typedFolders.length === 1 ? '' : 's'} ¬∑ ${totalEntries} ${totalEntries === 1 ? 'entry' : 'entries'}`} />
      </div>
    </header>

    {typedFolders.length > 0 ? (
      <div class="folders-container">
        <div class="folders-grid">
          <div class="folders-column">
            {leftColumnFolders.map((folder, i) => (
              <article id={folder.id} class="folder-card" style={`order: ${i * 2}`}>
                <header class="folder-header">
                  <h2 class="folder-title">
                    <a class="folder-title-link" href={`/notes/${folder.id}`}>
                      {folder.title}
                    </a>
                  </h2>
                  {folder.description && (
                    <p class="folder-description">{folder.description}</p>
                  )}
                </header>
                <ul class="entry-list" role="list">
                  {folder.entries.slice(0, MAX_ENTRIES_PER_FOLDER).map((entry) => {
                    const enrichedEntry = entry as NotesEntryWithContent;
                    return (
                      <li class="entry-item">
                        <a class="entry-link" href={entryHref(enrichedEntry.collection, enrichedEntry.slug)}>
                          <span class="entry-link-title">{enrichedEntry.resolvedTitle}</span>
                          {enrichedEntry.resolvedDescription && (
                            <span class="entry-link-desc">{enrichedEntry.resolvedDescription}</span>
                          )}
                          <span class="entry-link-arrow" aria-hidden="true">‚Üí</span>
                        </a>
                        <span class="entry-badge">{collectionLabel(enrichedEntry.collection)}</span>
                      </li>
                    );
                  })}
                </ul>
                {folder.entries.length > MAX_ENTRIES_PER_FOLDER && (
                  <footer class="folder-footer">
                    <a class="view-all-link" href={`/notes/${folder.id}`}>
                      View all {folder.entries.length} entries
                      <span class="view-all-arrow" aria-hidden="true">‚Üí</span>
                    </a>
                  </footer>
                )}
              </article>
            ))}
          </div>
          <div class="folders-column">
            {rightColumnFolders.map((folder, i) => (
              <article id={folder.id} class="folder-card" style={`order: ${i * 2 + 1}`}>
                <header class="folder-header">
                  <h2 class="folder-title">
                    <a class="folder-title-link" href={`/notes/${folder.id}`}>
                      {folder.title}
                    </a>
                  </h2>
                  {folder.description && (
                    <p class="folder-description">{folder.description}</p>
                  )}
                </header>
                <ul class="entry-list" role="list">
                  {folder.entries.slice(0, MAX_ENTRIES_PER_FOLDER).map((entry) => {
                    const enrichedEntry = entry as NotesEntryWithContent;
                    return (
                      <li class="entry-item">
                        <a class="entry-link" href={entryHref(enrichedEntry.collection, enrichedEntry.slug)}>
                          <span class="entry-link-title">{enrichedEntry.resolvedTitle}</span>
                          {enrichedEntry.resolvedDescription && (
                            <span class="entry-link-desc">{enrichedEntry.resolvedDescription}</span>
                          )}
                          <span class="entry-link-arrow" aria-hidden="true">‚Üí</span>
                        </a>
                        <span class="entry-badge">{collectionLabel(enrichedEntry.collection)}</span>
                      </li>
                    );
                  })}
                </ul>
                {folder.entries.length > MAX_ENTRIES_PER_FOLDER && (
                  <footer class="folder-footer">
                    <a class="view-all-link" href={`/notes/${folder.id}`}>
                      View all {folder.entries.length} entries
                      <span class="view-all-arrow" aria-hidden="true">‚Üí</span>
                    </a>
                  </footer>
                )}
              </article>
            ))}
          </div>
        </div>
      </div>
    ) : (
      <div class="empty-state">
        <div class="empty-state-icon" aria-hidden="true">üìÅ</div>
        <p class="empty-state-title">No folders yet</p>
        <p class="empty-state-desc">Notes folders will appear here once you add them.</p>
      </div>
    )}
  </main>

  <style>
    .notes-page {
      max-width: 960px;
      margin: 0 auto;
      padding: 3rem 1.5rem 8rem;
    }

    .page-header {
      margin-bottom: 3.5rem;
    }

    .page-label {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--color-accent);
      margin-bottom: 0.5rem;
    }

    .page-title {
      font-size: clamp(2rem, 5vw, 2.5rem);
      font-weight: 700;
      letter-spacing: -0.03em;
      line-height: var(--line-height-tight);
      margin-bottom: 0.75rem;
      color: var(--color-text);
    }

    .page-intro {
      max-width: 540px;
      font-size: var(--font-size-lg);
      line-height: 1.65;
      color: var(--color-text-muted);
      margin-bottom: 1.25rem;
    }

    .page-meta {
      font-size: var(--font-size-sm);
      color: var(--color-text-muted);
    }

    .folders-container {
      position: relative;
    }

    .folders-grid {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .folders-column {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .folder-card {
      padding: 1.75rem;
      border-radius: var(--border-radius-lg);
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      transition: border-color var(--transition-base), box-shadow var(--transition-base);
    }

    .folder-card:hover {
      border-color: var(--color-border);
      box-shadow: var(--shadow-md);
    }

    .folder-header {
      margin-bottom: 1.25rem;
    }

    .folder-title {
      font-size: var(--font-size-xl);
      font-weight: 600;
      letter-spacing: -0.02em;
      margin: 0 0 0.25rem 0;
      line-height: 1.3;
    }

    .folder-title-link {
      color: var(--color-text);
      text-decoration: none;
      transition: color var(--transition-fast);
    }

    .folder-title-link:hover {
      color: var(--color-accent);
    }

    .folder-description {
      font-size: var(--font-size-sm);
      line-height: 1.5;
      color: var(--color-text-muted);
      margin: 0;
    }

    .entry-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0;
      border-top: 1px solid var(--color-border-subtle);
    }

    .entry-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 0.875rem 0;
      border-bottom: 1px solid var(--color-border-subtle);
    }

    .entry-item:last-child {
      border-bottom: none;
    }

    .entry-link {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 0.75rem;
      text-decoration: none;
      color: var(--color-text);
      transition: color var(--transition-fast);
    }

    .entry-link:hover {
      color: var(--color-accent);
    }

    .entry-link:hover .entry-link-arrow {
      opacity: 1;
      transform: translateX(2px);
    }

    .entry-link-title {
      flex: 1;
      min-width: 0;
      font-weight: 500;
      font-size: var(--font-size-base);
    }

    .entry-link-desc {
      display: none;
    }

    @media (min-width: 540px) {
      .entry-link {
        position: relative;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.2rem;
        padding-right: 1.5rem;
      }

      .entry-link-desc {
        display: -webkit-box;
        font-size: var(--font-size-sm);
        color: var(--color-text-muted);
        line-height: 1.4;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .entry-link:hover .entry-link-desc {
        color: var(--color-text-secondary);
      }

      .entry-link-arrow {
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
      }

      .entry-link:hover .entry-link-arrow {
        transform: translateY(-50%) translateX(2px);
      }
    }

    .entry-link-arrow {
      flex-shrink: 0;
      font-size: var(--font-size-sm);
      color: var(--color-accent);
      opacity: 0;
      transition: opacity var(--transition-fast), transform var(--transition-fast);
    }

    .entry-badge {
      flex-shrink: 0;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      background: var(--color-accent-muted);
      color: var(--color-accent);
      border: 1px solid transparent;
    }

    .folder-footer {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--color-border-subtle);
    }

    .view-all-link {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-weight: 500;
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      text-decoration: none;
      transition: color var(--transition-fast), gap var(--transition-fast);
    }

    .view-all-link:hover {
      color: var(--color-accent);
      gap: 0.5rem;
    }

    .view-all-arrow {
      font-size: 0.9em;
      transition: transform var(--transition-fast);
    }

    .view-all-link:hover .view-all-arrow {
      transform: translateX(2px);
    }

    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
      border: 1px dashed var(--color-border);
      border-radius: var(--border-radius-lg);
      background: var(--color-bg-secondary);
    }

    .empty-state-icon {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      opacity: 0.6;
    }

    .empty-state-title {
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 0.5rem;
    }

    .empty-state-desc {
      font-size: var(--font-size-sm);
      color: var(--color-text-muted);
      margin: 0;
    }

    @media (min-width: 720px) {
      .folders-grid {
        flex-direction: row;
        align-items: stretch;
        gap: 1.5rem;
      }

      .folders-column {
        flex: 1;
        min-width: 0;
      }

      .folders-column .folder-card {
        order: unset;
      }
    }

    @media (max-width: 719px) {
      .notes-page {
        padding: 2.5rem 1rem 6rem;
      }

      .folders-column {
        display: contents;
      }

      .folder-card {
        padding: 1.5rem;
      }

      .entry-item {
        flex-wrap: wrap;
      }

      .entry-badge {
        margin-left: auto;
      }
    }
  </style>
</BaseLayout>
